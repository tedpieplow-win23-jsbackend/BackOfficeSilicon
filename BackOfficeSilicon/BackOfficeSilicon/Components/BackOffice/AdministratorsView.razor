@inject UserService UserService
@inject UserManager<ApplicationUser> UserManager
@inject AdminService AdminService
@inject ILogger<AdministratorsView> Logger

@rendermode InteractiveAuto

<div class="container admin-view">
    <QuickGrid Items="AdminList.AsQueryable()" Class="quickgrid-table">
        <PropertyColumn Property="l => l.Email" Title="Email" Sortable="true" />
        <PropertyColumn Property="l => l.FirstName" Title="First Name" />
        <PropertyColumn Property="l => l.LastName" Title="Last Name" />
        <TemplateColumn Title="Role">
            <select name="roles" id="role-select" @onchange="@((ChangeEventArgs e) => NewRole = e.Value!.ToString())">
                <option value=@(context.Role)>@(context.Role)</option>
                <option class="@DisplayRole(context.Role, "SuperUser")" value="SuperUser">Super User</option>
                <option class="@DisplayRole(context.Role, "Administrator")" value="Administrator">Administrator</option>
                <option class="@DisplayRole(context.Role, "Author")" value="Author">Author</option>
                <option class="@DisplayRole(context.Role, "User")" value="User">User</option>
            </select>
            @if(NewRole != null)
            {
                <button class="btn-theme" @onclick="async () => await UpdateRoleAsync(context, NewRole)"><i class="fa-solid fa-floppy-disk"></i></button>
            }
        </TemplateColumn>
        <TemplateColumn Title="Update">
            <button class="btn-theme" @onclick="() => UpdateAdmin(context.Email)"><i class="fa-solid fa-pen"></i></button>
        </TemplateColumn>
    </QuickGrid>
</div>

@code {

    [Parameter]
    public EventCallback<string> OnClick { get; set; }

    private string? NewRole { get; set; }

    private List<AdministratorModel> AdminList { get; set; } = [];

    protected override async Task OnParametersSetAsync()
    {
        AdminList = await AdminService.PopulateAdminListAsync();
    }

    public string DisplayRole(string currentRole, string optionValue) => (currentRole == optionValue) ? "d-none" : "";

    public async Task UpdateRoleAsync(AdministratorModel model, string newRole)
    {
        var admin = await UserManager.FindByEmailAsync(model.Email);
        await UserManager.RemoveFromRoleAsync(admin!, model.Role);
        await UserManager.AddToRoleAsync(admin!, newRole);
        model.Role = newRole;
        NewRole = null!;

        await InvokeAsync(() => StateHasChanged());
    }

    public async Task UpdateAdmin(string Email)
    {
        await OnClick.InvokeAsync(Email);
    }

}
